<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>CMS Admin</title>
    <link rel="stylesheet" href="{{ theme_url }}/style.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="{{ theme_url }}/js/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="{{ theme_url }}/js/chart.min.js"></script>
</head>
<body class="admin-{{ page_id }}">
<header>
    <div class="header-content">
        <h1>CMS Administration</h1>
        <div class="header-controls">
            <div class="notification-icon" title="Recent Notifications">
                <span class="icon">ðŸ””</span>
                <div class="notification-dropdown">
                    <div class="notification-header">Recent Activity</div>
                    <div class="notification-list">
                        <!-- Notifications will be populated via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{ breadcrumbs_html|raw }}
    {{ notifications_html|raw }}
</header>
<div class="admin-layout">
    {{ sidebar|raw }}
    <main class="admin-content">
        {{ content|raw }}
    </main>
</div>
<script>
$(function(){
    $('.nav-menu').on('click','.submenu-toggle', function(e){
        e.preventDefault();
        var $btn=$(this);
        var $sub=$('#'+$btn.attr('aria-controls'));
        $sub.slideToggle(150);
        var expanded=$btn.attr('aria-expanded')==='true';
        $btn.attr('aria-expanded', expanded?'false':'true');
    });

    $('.nav-menu li').each(function(){
        var $li = $(this);
        var $link = $li.children('a').first();
        var $toggle = $li.children('.submenu-toggle').first();
        var $submenu = $li.children('.sub-menu').first();

        if($toggle.length && $submenu.length) {
            $link.on('click', function(e){
                e.preventDefault();
                $toggle.trigger('click');
                return false;
            });
        }
    });

    $('.notify-dismiss').on('click', function(e){
        e.preventDefault();
        var id = $(this).data('id');
        var $li = $(this).closest('li');
        $.post('notifications.php', {id:id}).done(function(){
            $li.fadeOut(150, function(){ $(this).remove(); });
        });
    });

    // Notification icon functionality
    $('.notification-icon').on('click', function(e){
        e.preventDefault();
        e.stopPropagation();
        var $dropdown = $(this).find('.notification-dropdown');
        if($dropdown.is(':visible')) {
            $dropdown.fadeOut(150);
        } else {
            loadNotifications();
            $dropdown.fadeIn(150);
        }
    });

    // Close notification dropdown when clicking outside
    $(document).on('click', function(){
        $('.notification-dropdown').fadeOut(150);
    });

    function loadNotifications() {
        $.get('notifications.php?action=recent&limit=10')
            .done(function(data) {
                var $list = $('.notification-list');
                $list.empty();
                if(data && data.length > 0) {
                    data.forEach(function(notification) {
                        var $item = $('<div class="notification-item">');
                        $item.html('<div class="notification-type">' + 
                                  escapeHtml(notification.type) + '</div>' +
                                  '<div class="notification-message">' + 
                                  escapeHtml(notification.message) + '</div>' +
                                  '<div class="notification-time">' + 
                                  escapeHtml(notification.created) + '</div>');
                        $list.append($item);
                    });
                } else {
                    $list.html('<div class="no-notifications">No recent notifications</div>');
                }
            })
            .fail(function() {
                $('.notification-list').html('<div class="notification-error">Error loading notifications</div>');
            });
    }

    function escapeHtml(text) {
        var map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
    $('body').on('click','.help-icon',function(e){
        e.preventDefault();
        var txt=$(this).data('help');
        if(!txt) return;
        var $m=$('<div class="help-modal" aria-label="Help"><div class="dialog"></div></div>');
        $m.find('.dialog').text(txt);
        $('body').append($m);
        $m.fadeIn(100);
        $m.on('click',function(){ $m.fadeOut(150,function(){ $m.remove(); }); });
    });
});
</script>
</body>
</html>
